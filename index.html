<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<title>Pepys Coverage</title>
		<link href="./css/bootstrap-material-design.min.css" rel="stylesheet" type='text/css'>
		
		<!-- Visavail.js 1.5.0 style -->
		<link href='./css/visavail.min.css' rel='stylesheet' type='text/css'>
		<link href='./css/style.css' rel='stylesheet' type='text/css'>
		<!-- font-awesome -->
		<link href='./css/fonts/fontawesome_5_15_3/css/all.css' rel='stylesheet' type='text/css'>

	</head>

	<body>
		<nav class="navbar navbar-light bg-dark">
			<span class="navbar-brand text-light">
				<h2>Pepys Coverage</h2>
			</span>
			<button type="button" class="btn btn-raised btn-success" id="data-received-button"
				onclick="onDataReceived()">
				Data Received
			</button>
		</nav>
		<div class="m-5"></div>
		<div class="container-fluid">
			<div id="chart_row" class="row justify-content-center">
				<!-- <div class="col-md-3 col-xl-2">
					<div class="card">
						<div class="platform-heading">
							<h5>J05130 - CASEX 324</h5>
						</div>
						<div style="overflow: hidden;" class="visavail" id="visavail_container_1">
							<p id="visavail_graph_1">
							</p>
						</div>
					</div>
				</div>
				<div class="col-md-3 col-xl-2">
					<div class="card">
						<div class="platform-heading">
							<h5>J05130 - CASEX 324</h5>
						</div>
						<div style="overflow: hidden;" class="visavail" id="visavail_container_2">
							<p id="visavail_graph_2">
							</p>
						</div>
					</div>
				</div>
				<div class="col-md-3 col-xl-2">
					<div class="card">
						<div class="platform-heading">
							<h5>J05210 - PASSEX 5A</h5>
						</div>
						<div style="overflow: hidden;" class="visavail" id="visavail_container_3">
							<p id="visavail_graph_3">
							</p>
						</div>
					</div>
				</div>
				<div class="col-md-3 col-xl-2">
					<div class="card">
						<div class="platform-heading">
							<h5>J05240 - CASEX 477</h5>
						</div>
						<div style="overflow: hidden;" class="visavail" id="visavail_container_4">
							<p id="visavail_graph_4">
							</p>
						</div>
					</div>
				</div>
				<div class="col-md-3 col-xl-2">
					<div class="card">
						<div class="platform-heading">
							<h5>JJ05289 - CASEX 114</h5>
						</div>
						<div style="overflow: hidden;" class="visavail" id="visavail_container_5">
							<p id="visavail_graph_5">
							</p>
						</div>
					</div>
				</div> -->
			</div>
		</div>
		<!-- Moment 2.22.1 -->
		<script src="./js/moment-with-locales.min.js" type="text/javascript"></script>
		<!-- D3 5.9.2 -->
		<script src="./js/d3.min.js"></script>
		<!-- Visavail 1.5.0 -->
		<script src="./js/visavail.min.js"></script>

		<script type="text/javascript">
			moment.locale("en");

			function onDataReceived() {
				console.log('on data received');
			}

			var commonDate = new Date("01/01/2020");
			var stripDateOfChars = date => date.toISOString().slice(0, -5).replace('T', ' ');

			var rawData = [{
					"serial": "J05130 - CASEX 324",
					"start_time": '2016-01-01 10:00:00',
					"end_time": '2016-01-01 12:00:00',
					"participants": [{
							"name": "RICH",
							"platform-type": 'missile',
							"percent-coverage": 55,
							"coverage": [
								['2016-01-01 10:00:00', '2016-01-01 10:40:00'],
								['2016-01-01 10:50:00', '2016-01-01 11:05:00'],
								['2016-01-01 11:30:00', '2016-01-01 12:00:00'],
							]
						},
						{
							"name": "DUKE",
							"platform-type": 'jammer',
							"percent-coverage": 25,
							"coverage": [
								['2016-01-01 10:15:00', '2016-01-01 10:30:00'],
								['2016-01-01 10:35:00', '2016-01-01 11:00:00'],
								['2016-01-01 11:40:00', '2016-01-01 12:00:00'],
							]
						},
						{
							"name": "CUMB",
							"platform-type": 'merchant',
							"percent-coverage": 75,
							"coverage": [
								['2016-01-01 10:00:00', '2016-01-01 10:05:00'],
								['2016-01-01 10:45:00', '2016-01-01 11:00:00'],
								['2016-01-01 11:45:00', '2016-01-01 12:00:00'],
							]
						}
					]
				},
				{
					"serial": "J05150 - PASSEX 4A",
					"start_time": '2016-01-01 12:00:00',
					"end_time": '2016-01-01 14:00:00',
					"participants": [{
							"name": "TRAV",
							"platform-type": 'missile',
							"percent-coverage": 65,
							"coverage": [
								['2016-01-01 12:00:00', '2016-01-01 12:10:00'],
								['2016-01-01 12:50:00', '2016-01-01 13:15:00'],
								['2016-01-01 13:30:00', '2016-01-01 14:00:00'],
							]
						},
						{
							"name": "PART",
							"platform-type": 'jammer',
							"percent-coverage": 35,
							"coverage": [
								['2016-01-01 12:15:00', '2016-01-01 12:30:00'],
								['2016-01-01 12:35:00', '2016-01-01 13:00:00'],
								['2016-01-01 13:40:00', '2016-01-01 14:00:00'],
							]
						},
						{
							"name": "MISH",
							"platform-type": 'merchant',
							"percent-coverage": 75,
							"coverage": [
								['2016-01-01 12:15:00', '2016-01-01 12:25:00'],
								['2016-01-01 12:45:00', '2016-01-01 13:00:00'],
								['2016-01-01 13:45:00', '2016-01-01 14:00:00'],
							]
						}
					]
				}
			];

			function calculatePercentageClass(number) {
				switch (true) {

					case number <= 25:
						return "ypercentage_red";
						break;
					case number <= 60:
						return "ypercentage_amber";
						break;
					case number <= 100:
						return "ypercentage_green";
						break;
					default:
						return "ypercentage";

				};
			}
			var transformedData = rawData.map(serial => {
				return serial.participants.map(participant => {
					// overall coverage
					const overall = []
					for (let index = 0; index < participant.coverage.length; index++) {
						if (index != 0) {
							if (new Date(participant.coverage[index - 1][1]).getTime() < new Date(participant.coverage[index][0]).getTime()) {
								overall.push([participant.coverage[index - 1][1], 0, participant.coverage[index][0]])
							}
						} else {
							overall.push([serial.start_time, 0, participant.coverage[index][1]])
						}
						overall.push([participant.coverage[index][0], 1, participant.coverage[index][1]])


					}
					const data = overall
					return {
						measure: participant.name,
						icon: {
							url: "https://raw.githubusercontent.com/debrief/debrief-icons/master/svg/" + participant["platform-type"] + ".svg",
							width: 24,
							height: 24,
							padding: {
								left: 0,
								right: 5
							},
							background_class: participant["platform-type"]
						},
						percentage: {
							measure: participant["percent-coverage"] + " %",
							class: calculatePercentageClass(participant["percent-coverage"])
						},
						data: data
					}
				})
			})

			const default_options = {
				margin: {
					right: 30,
					left: 40,
					top: 10,
					bottom: 0
				},
				padding: {
					top: 0,
					bottom: 0,
					right: -2,
					left: 2
				},
				reduce_space_wrap: 2000000000,
				title: {
					enabled: false
				},
				sub_title: {
					enabled: false
				},
				legend: {
					enabled: false
				},
				y_title_tooltip: {
					enabled: false
				},

				icon: {
					class_has_data: 'fas fa-fw fa-check',
					class_has_no_data: 'fas fa-fw fa-exclamation-circle'
				},
				responsive: {
					enabled: false,
				},
				line_spacing: 12,
				ticks_for_graph: 0,
				graph: {
					height: 25
				},
				y_percentage: {
					enabled: true,
					custom_percentage: true
				},
				responsive: {
					enabled: true
				}
			};

			// maintain list of charts, so we can resize them on browser resize
			const charts = []

			function addChartDiv(index, header) {

				var newDiv = document.createElement('div');
				htmlString = '<div class="card"><div class="card-header text-center"><h5>'+header+'</h5></div><div style="overflow: hidden;" class="visavail" id="visavail_container_new_'+index+'"><p id="visavail_graph_new_'+index+'"></p></div></div>'
				newDiv.innerHTML = htmlString.trim();
				newDiv.classList.add("col-md-3")
				newDiv.classList.add("col-xl-2")

				var currentDiv = document.getElementById("chart_row");
				currentDiv.appendChild(newDiv);
			}
			// create 5 graphs
			var options = []
			var header = [
				"J05130 - CASEX 324",
				"J05130 - CASEX 324",
				"J05210 - PASSEX 5A",
				"J05240 - CASEX 477",
				"JJ05289 - CASEX 114"
			]
			for (i = 0; i < 5; i++) {
				options.push(default_options)
				addChartDiv(i+1, header[i])
				// override the target ids
				options[i].id_div_container = "visavail_container_new_" + (i + 1)
				options[i].id_div_graph = "visavail_graph_new_" + (i + 1)

				// take deep copy of data. For some reason using a dataset
				// more than once mangles it
				const data = JSON.parse(JSON.stringify(transformedData[i % 2]))

				// create new chart instance
				charts[i] = visavail.generate(options[i], data);
			}
		</script>
		
	</body>

</html>